<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>Guida — Tetris — pezzaliAPP</title>
  <meta name="theme-color" content="#0b5fff">
  <style>
    :root{--c1:#0f1320;--c2:#151b31;--c3:#0b5fff;--txt:#e9eef5}
    *{box-sizing:border-box} html,body{margin:0;height:100%}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--c1);color:var(--txt)}
    header{position:sticky;top:0;background:var(--c3);color:#fff;padding:12px 16px;box-shadow:0 2px 12px rgba(0,0,0,.25)}
    main{max-width:900px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .card{background:var(--c2);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    h1{font-size:1.2rem;margin:.2rem 0}
    h2{font-size:1.05rem;margin:.2rem 0 .6rem}
    code,kbd{background:rgba(255,255,255,.08);padding:2px 6px;border-radius:6px}
    .grid{display:grid;grid-template-columns:1fr 340px;gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    canvas{background:#12182a;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.35);width:100%;height:auto}
    .muted{opacity:.9}
    .footer{opacity:.7;font-size:.9rem}
    a{color:#aacbff}
  </style>
</head>
<body>
  <header>
    <h1>Guida — Tetris — pezzaliAPP</h1>
  </header>
  <main>
    <section class="grid">
      <div class="card">
        <h2>Come si gioca</h2>
        <ul>
          <li><kbd>◀︎/▶︎</kbd> Muovi • <kbd>▼</kbd> Soft drop • <kbd>Space</kbd> Hard drop</li>
          <li><kbd>Z/X</kbd> Ruota • <kbd>C</kbd> Hold • <kbd>P</kbd> Pausa • <kbd>R</kbd> Restart</li>
        </ul>
        <p class="muted">Funziona offline, è installabile come app su iPhone/iPad/Android/PC/Mac.</p>
      </div>
      <div class="card">
        <h2>Demo</h2>
        <canvas id="demo" width="240" height="240" aria-label="Demo animata Tetris"></canvas>
        <p class="muted">Mini‑demo in Canvas: tetromino rotante con anteprima blocchi.</p>
      </div>
    </section>

    <section class="card">
      <h2>Installazione su iPhone</h2>
      <ol>
        <li>Apri la pagina con Safari.</li>
        <li>Tocca <strong>Condividi</strong> → <strong>Aggiungi a Home</strong>.</li>
        <li>Avvia l’app dalla Home per schermo intero.</li>
      </ol>
      <p class="muted">Se aggiorni l’app, chiudi e riapri con connessione oppure incrementa la costante <code>CACHE</code> nel <code>service-worker.js</code>.</p>
    </section>

    <section class="card">
      <h2>Licenza</h2>
      <p>MIT — © 2025 pezzaliAPP</p>
    </section>

    <p class="footer">Parte della collezione giochi pezzaliAPP.</p>
  </main>

 <script>
// Mini-Tetris fedele nel canvas #demo (giocabile)
// — grid 10x20, tile 12px, 7-bag, gravity, lock, line clear

const c = document.getElementById('demo');
const ctx = c.getContext('2d');

// Board
const W = 10, H = 20, TILE = 12;
const offX = Math.floor((c.width - W*TILE)/2);
const offY = 0;

// Shapes (4x4) – coordinate celle [x,y]
const SHAPES = {
  I: [[0,1],[1,1],[2,1],[3,1]],
  J: [[0,0],[0,1],[1,1],[2,1]],
  L: [[2,0],[0,1],[1,1],[2,1]],
  O: [[1,0],[2,0],[1,1],[2,1]],
  S: [[1,0],[2,0],[0,1],[1,1]],
  Z: [[0,0],[1,0],[1,1],[2,1]],
  T: [[1,0],[0,1],[1,1],[2,1]],
};
const COLORS = {
  I:'#63e6ff', O:'#ffd43b', T:'#845ef7', S:'#51cf66', Z:'#ff6b6b', J:'#4dabf7', L:'#ffa94d'
};

// SRS kick (semplificato) per pezzi non-I e per I
const KICKS = {
  normal: {
    0:{1:[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],3:[[0,0],[+1,0],[+1,-1],[0,2],[+1,2]]},
    1:{2:[[0,0],[+1,0],[+1,+1],[0,-2],[+1,-2]],0:[[0,0],[-1,0],[-1,+1],[0,-2],[-1,-2]]},
    2:{3:[[0,0],[+1,0],[+1,-1],[0,2],[+1,2]],1:[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]]},
    3:{0:[[0,0],[-1,0],[-1,+1],[0,-2],[-1,-2]],2:[[0,0],[+1,0],[+1,+1],[0,-2],[+1,-2]]}
  },
  I: {
    0:{1:[[0,0],[-2,0],[+1,0],[-2,+1],[+1,-2]],3:[[0,0],[+2,0],[-1,0],[+2,-1],[-1,+2]]},
    1:{2:[[0,0],[-1,0],[+2,0],[-1,-2],[+2,+1]],0:[[0,0],[+2,0],[-1,0],[+2,-1],[-1,+2]]},
    2:{3:[[0,0],[+2,0],[-1,0],[+2,+1],[-1,-2]],1:[[0,0],[+1,0],[-2,0],[+1,+2],[-2,-1]]},
    3:{0:[[0,0],[+1,0],[-2,0],[+1,-2],[-2,+1]],2:[[0,0],[-2,0],[+1,0],[-2,+1],[+1,-2]]}
  }
};

let board = Array.from({length:H},()=>Array(W).fill(0));

class Bag7 {
  constructor(){ this.b=[]; }
  next(){
    if (!this.b.length) this.b = ['I','J','L','O','S','T','Z'].sort(()=>Math.random()-0.5);
    return this.b.pop();
  }
}
const bag = new Bag7();

function newPiece(type){
  const p = {
    t:type, r:0, x:3, y:-1,
    cells: SHAPES[type].map(([x,y])=>({x,y}))
  };
  return p;
}

let curr = newPiece(bag.next()), nextType = bag.next();
let fallTimer = 0, fallDelay = 550; // ms
let lastTs = 0;
let clearing = []; // righe in flash

function valid(p, dx=0, dy=0, rDelta=0){
  const r = (p.r + rDelta + 4) % 4;
  for (const {x,y} of rotateCells(p.cells, r)){
    const nx = p.x + x + dx;
    const ny = p.y + y + dy;
    if (nx < 0 || nx >= W || ny >= H) return false;
    if (ny >= 0 && board[ny][nx]) return false;
  }
  return true;
}

function rotateCells(cells, rot){
  // Rotazione 90° a passi su bounding 4x4 (x,y in 0..3)
  return cells.map(({x,y})=>{
    let nx=x, ny=y;
    for (let i=0;i<rot;i++){ const tx = 3 - ny; const ty = x; nx=tx; ny=ty; x=nx; y=ny; }
    return {x:nx,y:ny};
  });
}

function tryRotate(dir){
  const to = (curr.r + dir + 4) % 4;
  const sys = (curr.t==='I'? KICKS.I : KICKS.normal);
  const table = sys[curr.r][to];
  const rotated = { ...curr, r:to };
  for (const [kx,ky] of table){
    if (valid(rotated, kx, ky, 0)){ curr.r = to; curr.x += kx; curr.y += ky; return; }
  }
}

function lock(){
  for (const {x,y} of rotateCells(curr.cells, curr.r)){
    const gx = curr.x + x, gy = curr.y + y;
    if (gy >= 0) board[gy][gx] = curr.t;
  }
  // clear lines
  clearing = [];
  for (let y=H-1;y>=0;y--){
    if (board[y].every(v=>v)) clearing.push(y);
  }
  if (clearing.length){
    // piccola pausa/flash
    setTimeout(()=>{
      for (const y of clearing){
        board.splice(y,1);
        board.unshift(Array(W).fill(0));
      }
      clearing = [];
    }, 80);
  }
  // new piece
  curr = newPiece(nextType);
  nextType = bag.next();
  if (!valid(curr,0,0,0)) gameOver();
}

let over = false;
function gameOver(){ over = true; }

function hardDrop(){
  while (valid(curr,0,1,0)) curr.y++;
  lock();
}

function step(ts){
  if (over) { draw(); return; }
  if (!lastTs) lastTs = ts;
  const dt = ts - lastTs; lastTs = ts;
  fallTimer += dt;
  if (fallTimer >= fallDelay){
    fallTimer = 0;
    if (valid(curr,0,1,0)) curr.y++;
    else lock();
  }
  draw();
  requestAnimationFrame(step);
}

function draw(){
  // sfondo & griglia
  ctx.fillStyle = '#0e1429'; ctx.fillRect(0,0,c.width,c.height);
  ctx.strokeStyle = 'rgba(255,255,255,.06)';
  for (let x=0;x<=W;x++){ ctx.beginPath(); ctx.moveTo(offX + x*TILE, offY); ctx.lineTo(offX + x*TILE, offY + H*TILE); ctx.stroke(); }
  for (let y=0;y<=H;y++){ ctx.beginPath(); ctx.moveTo(offX, offY + y*TILE); ctx.lineTo(offX + W*TILE, offY + y*TILE); ctx.stroke(); }

  // pezzi piazzati
  for (let y=0;y<H;y++){
    for (let x=0;x<W;x++){
      const t = board[y][x];
      if (t){
        drawTile(x,y, COLORS[t], clearing.includes(y) ? 0.35 : 1);
      }
    }
  }

  // ghost
  const g = {...curr};
  while (valid(g,0,1,0)) g.y++;
  drawPiece(g, true);

  // corrente
  drawPiece(curr, false);
}

function drawPiece(p, ghost){
  const cols = rotateCells(p.cells, p.r);
  for (const {x,y} of cols){
    const gx = p.x + x, gy = p.y + y;
    if (gy < 0) continue;
    drawTile(gx,gy, COLORS[p.t], ghost ? 0.25 : 1);
  }
}

function drawTile(x,y,color,alpha=1){
  const px = offX + x*TILE, py = offY + y*TILE;
  ctx.save();
  ctx.globalAlpha = alpha;
  ctx.fillStyle = color;
  ctx.fillRect(px+1, py+1, TILE-2, TILE-2);
  ctx.globalAlpha = Math.min(alpha, .22);
  ctx.fillStyle = '#fff';
  ctx.fillRect(px+1, py+1, TILE-2, 4);
  ctx.restore();
}

// Input
document.addEventListener('keydown', e=>{
  if (over) return;
  if (e.code==='ArrowLeft'){ if (valid(curr,-1,0,0)) curr.x--; }
  else if (e.code==='ArrowRight'){ if (valid(curr,1,0,0)) curr.x++; }
  else if (e.code==='ArrowDown'){ if (valid(curr,0,1,0)) curr.y++; }
  else if (e.code==='Space'){ e.preventDefault(); hardDrop(); }
  else if (e.code==='KeyZ'){ tryRotate(-1); }
  else if (e.code==='KeyX'){ tryRotate(1); }
});

requestAnimationFrame(step);
</script>
</body>
</html>
